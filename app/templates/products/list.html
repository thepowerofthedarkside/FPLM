{% extends "base.html" %}
{% block content %}
<h1>Изделия</h1>

<div class="card">
  <form method="get" action="/products" class="grid products-filter-row js-live-filter" id="productsFilterForm">
    <div><label>Поиск изделий</label><input id="productsLiveSearch" name="q" value="{{ q }}" placeholder="SKU или наименование" autocomplete="off"></div>
    <div>
      <label>Статус</label>
      <select name="status_filter">
        <option value="">Все</option>
        {% for st in statuses %}<option value="{{ st }}" {% if status_filter==st %}selected{% endif %}>{{ status_labels.get(st, st) }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Категория</label>
      <select name="category_id_raw">
        <option value="">Все</option>
        {% for item in category_items %}<option value="{{ item.id }}" {% if selected_category_id==item.id %}selected{% endif %}>{{ item.label }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label><span class="label-row">Коллекция <span class="tooltip" data-tip="Фильтр показывает только изделия выбранной коллекции.">?</span></span></label>
      <select name="collection_id_raw">
        <option value="">Все</option>
        {% for c in collections %}<option value="{{ c.id }}" {% if selected_collection_id==c.id %}selected{% endif %}>{{ c.code }} - {{ c.name }}</option>{% endfor %}
      </select>
    </div>
    <div>
      <label>Сортировка</label>
      <select name="sort">
        <option value="updated_desc" {% if sort=='updated_desc' %}selected{% endif %}>По обновлению</option>
        <option value="created_desc" {% if sort=='created_desc' %}selected{% endif %}>По дате создания</option>
        <option value="name_asc" {% if sort=='name_asc' %}selected{% endif %}>По названию</option>
      </select>
    </div>
    <div><label>&nbsp;</label><button type="button" class="secondary" onclick="document.getElementById('productsFullSearchModal').showModal()">Полный поиск</button></div>
    <div><label>&nbsp;</label><a href="/products" class="btn secondary">Сбросить фильтр</a></div>
  </form>
  {% if full_search_active %}
  <p class="small muted" style="margin-top:8px;">Включен полный поиск: учитываются все атрибуты изделия.</p>
  {% endif %}
</div>
<dialog id="productsFullSearchModal" class="modal">
  <div class="modal-body">
    <div class="modal-header">
      <h3>Полный поиск по атрибутам</h3>
      <form method="dialog"><button type="submit" class="secondary">Закрыть</button></form>
    </div>
    <form method="get" action="/products" class="grid">
      <input type="hidden" name="q" value="{{ q }}">
      <input type="hidden" name="status_filter" value="{{ status_filter }}">
      <input type="hidden" name="category_id_raw" value="{{ selected_category_id or '' }}">
      <input type="hidden" name="collection_id_raw" value="{{ selected_collection_id or '' }}">
      <input type="hidden" name="sort" value="{{ sort }}">
      {% for attr in full_search_attributes %}
      {% set cfg = full_search_values.get(attr.id, {}) %}
      <div>
        <label>{{ attr.name }}</label>
        {% if attr.data_type == "bool" %}
        {% set v = cfg.get('value', '') %}
        <select name="fs_a_{{ attr.id }}_bool">
          <option value="">-</option>
          <option value="1" {% if v == '1' %}selected{% endif %}>Да</option>
          <option value="0" {% if v == '0' %}selected{% endif %}>Нет</option>
        </select>
        {% elif attr.data_type == "enum" %}
          {% set selected_values = cfg.get('values', []) %}
          {% set options = full_search_enum_options.get(attr.id, []) %}
          {% if attr.is_multivalue %}
          <details class="multi-check-dropdown">
            <summary class="multi-check-summary">
              {% if selected_values %}Выбрано: {{ selected_values|length }}{% else %}Выберите значения{% endif %}
            </summary>
            <div class="multi-check-list">
              {% for item in options %}
              <label class="multi-check-item">
                <input type="checkbox" name="fs_a_{{ attr.id }}_enum" value="{{ item.id }}" {% if item.id in selected_values %}checked{% endif %}>
                <span>{{ item.label }}</span>
              </label>
              {% endfor %}
            </div>
          </details>
          {% else %}
          <select name="fs_a_{{ attr.id }}_enum">
            <option value="">-</option>
            {% for item in options %}
            <option value="{{ item.id }}" {% if selected_values and (selected_values[0] == item.id) %}selected{% endif %}>{{ item.label }}</option>
            {% endfor %}
          </select>
          {% endif %}
        {% else %}
        <input name="fs_a_{{ attr.id }}_value" value="{{ cfg.get('value', '') }}">
        {% endif %}
      </div>
      {% endfor %}
      <div><button type="submit">Поиск</button></div>
    </form>
  </div>
</dialog>

{% if can_manage %}
<div class="card">
  <div class="modal-actions" style="margin-bottom:0;">
    <button type="button" onclick="document.getElementById('createProductModal').showModal()">Создать изделие</button>
  </div>
  <dialog id="createProductModal" class="modal">
    <div class="modal-body">
      <div class="modal-header">
        <h3>Создать изделие</h3>
        <form method="dialog"><button type="submit" class="secondary">Закрыть</button></form>
      </div>
      <form method="post" action="/products" class="grid">
        <div><label>SKU*</label><input name="sku" required></div>
        <div><label>Наименование*</label><input name="name" required></div>
        <div>
          <label>Статус</label>
          <select name="status">
            {% for st in statuses %}<option value="{{ st }}">{{ status_labels.get(st, st) }}</option>{% endfor %}
          </select>
        </div>
        <div>
          <label>Категория</label>
          <select name="category_id_raw">
            <option value="">-</option>
            {% for item in category_items %}<option value="{{ item.id }}">{{ item.label }}</option>{% endfor %}
          </select>
        </div>
        <div style="grid-column:1/-1;"><label>Описание</label><textarea name="description"></textarea></div>
        <div><button type="submit">Создать</button></div>
      </form>
    </div>
  </dialog>
</div>
{% endif %}

<div class="product-grid" id="productGrid">
  {% for p in products %}
  <article class="product-card" data-search="{{ (p.sku ~ ' ' ~ p.name)|lower }}">
    <a href="/products/{{ p.id }}" class="product-card-link">
      <img src="/product-cover/{{ p.id }}.svg" alt="cover {{ p.sku }}" class="product-cover">
      <div class="product-card-body">
        <div class="product-line-1">
          <strong>{{ p.sku }}</strong>
          <span class="badge {{ p.status }}">{{ status_labels.get(p.status, p.status) }}</span>
        </div>
        <div class="product-name">{{ p.name }}</div>
        <div class="product-meta">{{ p.spec.collection.code if p.spec and p.spec.collection else "" }}</div>
        <div class="product-meta">{{ sample_stage_labels.get(p.spec.sample_stage, p.spec.sample_stage) if p.spec and p.spec.sample_stage else "" }}</div>
      </div>
    </a>
    <div class="product-card-body" style="padding-top:0;">
      <div class="product-meta">
        {% set tasks_count = product_task_counts.get(p.id, 0) %}
        <a href="/tasks/by-product/{{ p.id }}">Задачи: {{ tasks_count }}</a>
      </div>
    </div>
  </article>
  {% endfor %}
</div>
{% endblock %}
