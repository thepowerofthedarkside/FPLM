{% extends "base.html" %}
{% block content %}
<h1>Канбан: {{ board.name }}</h1>
<p class="muted">Перетащите карточку задачи в нужную колонку для смены статуса.</p>
{% if board.filter_queue %}
<p class="muted"><a href="/queues/{{ board.filter_queue.id }}">Связанная очередь: {{ board.filter_queue.name }}</a></p>
{% endif %}
<div class="modal-actions">
  <form method="get" action="/boards/{{ board.id }}/kanban" class="inline js-live-filter">
    <input name="q" value="{{ q or '' }}" placeholder="Быстрый поиск по атрибутам задач">
    <button type="submit" class="secondary">Поиск</button>
  </form>
  <form method="get" action="/boards/{{ board.id }}/kanban" class="inline">
    <button type="submit" class="secondary">Сбросить фильтр</button>
  </form>
  <button type="button" class="secondary" onclick="document.getElementById('kanbanFilterModal').showModal()">Фильтр по атрибутам</button>
</div>
<dialog id="kanbanFilterModal" class="modal">
  <div class="modal-body">
    <div class="modal-header">
      <h3>Фильтр по атрибутам задач</h3>
      <form method="dialog"><button type="submit" class="secondary">Закрыть</button></form>
    </div>
    <form method="get" action="/boards/{{ board.id }}/kanban" class="grid js-live-filter">
      <div><label>Быстрый поиск</label><input name="q" value="{{ q or '' }}"></div>
      <div><label>Очередь</label><select name="queue_id_raw"><option value="">Все</option>{% for qx in queues %}<option value="{{ qx.id }}" {% if selected_queue_id==qx.id %}selected{% endif %}>{{ qx.name }}</option>{% endfor %}</select></div>
      <div><label>Статус</label><select name="status_filter"><option value="">Все</option>{% for s in status_order %}<option value="{{ s }}" {% if selected_status==s %}selected{% endif %}>{{ task_status_labels.get(s, s) }}</option>{% endfor %}</select></div>
      <div><label>Приоритет</label><select name="priority"><option value="">Все</option>{% for p in priorities %}<option value="{{ p }}" {% if selected_priority==p %}selected{% endif %}>{{ task_priority_labels.get(p, p) }}</option>{% endfor %}</select></div>
      <div><label>Исполнитель</label><select name="assignee_id_raw"><option value="">Все</option>{% for u in users %}<option value="{{ u.id }}" {% if selected_assignee_id==u.id %}selected{% endif %}>{{ u.login }}</option>{% endfor %}</select></div>
      <div><label>Коллекция</label><select name="collection_id_raw"><option value="">Все</option>{% for c in collections %}<option value="{{ c.id }}" {% if selected_collection_id==c.id %}selected{% endif %}>{{ c.code }} - {{ c.name }}</option>{% endfor %}</select></div>
      <div><label>Изделие</label><select name="product_id_raw"><option value="">Все</option>{% for p in products %}<option value="{{ p.id }}" {% if selected_product_id==p.id %}selected{% endif %}>{{ p.sku }} - {{ p.name }}</option>{% endfor %}</select></div>
      <div><a href="/boards/{{ board.id }}/kanban" class="btn secondary">Сбросить фильтр</a></div>
    </form>
  </div>
</dialog>

{% if can_manage %}
<div class="modal-actions">
  <button type="button" onclick="document.getElementById('createTaskFromKanbanModal').showModal()">Создать задачу</button>
</div>
<dialog id="createTaskFromKanbanModal" class="modal">
  <div class="modal-body">
    <div class="modal-header">
      <h3>Создать задачу</h3>
      <form method="dialog"><button type="submit" class="secondary">Закрыть</button></form>
    </div>
    <form method="post" action="/tasks" class="grid">
      <div><label>Название</label><input name="title" required></div>
      <div><label>Теги</label><input name="tags" placeholder="outerwear, fw26"></div>
      <div><label>Статус</label><select name="status">{% for s in status_order %}<option value="{{ s }}">{{ task_status_labels.get(s, s) }}</option>{% endfor %}</select></div>
      <div><label>Приоритет</label><select name="priority">{% for p in priorities %}<option value="{{ p }}">{{ task_priority_labels.get(p, p) }}</option>{% endfor %}</select></div>
      <div><label>Начало</label><input type="date" name="start_date"></div>
      <div><label>Конец</label><input type="date" name="end_date"></div>
      <div><label>Дедлайн</label><input type="date" name="deadline"></div>
      {% if selected_queue_id %}
      <div><label>Очередь</label><input value="{% for qx in queues %}{% if qx.id==selected_queue_id %}{{ qx.name }}{% endif %}{% endfor %}" disabled></div>
      <input type="hidden" name="queue_id_raw" value="{{ selected_queue_id }}">
      {% else %}
      <div><label>Очередь</label><select name="queue_id_raw" required><option value="">-</option>{% for qx in queues %}<option value="{{ qx.id }}">{{ qx.name }}</option>{% endfor %}</select></div>
      {% endif %}
      <div><label>Исполнитель</label><select name="assignee_id_raw"><option value="">-</option>{% for u in users %}<option value="{{ u.id }}">{{ u.login }}</option>{% endfor %}</select></div>
      <div><label>Коллекция</label><select name="collection_id_raw"><option value="">-</option>{% for c in collections %}<option value="{{ c.id }}">{{ c.code }} - {{ c.name }}</option>{% endfor %}</select></div>
      <div><label>Изделие</label><select name="product_id_raw"><option value="">-</option>{% for p in products %}<option value="{{ p.id }}">{{ p.sku }} - {{ p.name }}</option>{% endfor %}</select></div>
      <div style="grid-column:1/-1;"><label>Комментарий</label><textarea name="comment"></textarea></div>
      <div><button type="submit">Создать</button></div>
    </form>
  </div>
</dialog>
{% endif %}

<div class="kanban-grid" data-dnd-enabled="{{ '1' if can_manage else '0' }}">
  {% for status in status_order %}
  <section class="kanban-col" data-status="{{ status }}">
    <h3>{{ task_status_labels.get(status, status) }}</h3>
    <div class="kanban-dropzone">
      {% for task in grouped.get(status, []) %}
      <article class="kanban-card" data-task-id="{{ task.id }}" draggable="{{ 'true' if can_manage else 'false' }}">
        <div><a href="/tasks/{{ task.id }}"><b>#{{ task.id }} {{ task.title }}</b></a></div>
        <div class="small muted">Важность: {{ task_priority_labels.get(task.priority, task.priority) }}</div>
        <div class="small muted">Автор: {{ task.author.login if task.author else 'не указан' }}</div>
        <div class="small muted">Исполнитель: {{ task.assignee.login if task.assignee else 'не назначен' }}</div>
        <div class="small muted">Дедлайн: {{ task.deadline.isoformat() if task.deadline else 'не задан' }}</div>
        <div class="small muted">Очередь: {{ task.queue.name if task.queue else 'не указана' }}</div>
        <div class="small muted">Коллекция: {{ (task.collection.code ~ ' - ' ~ task.collection.name) if task.collection else 'не указана' }}</div>
        <div class="small muted">Изделие: {{ (task.product.sku ~ ' - ' ~ task.product.name) if task.product else 'не указано' }}</div>
      </article>
      {% endfor %}
    </div>
  </section>
  {% endfor %}
</div>

<script>
(() => {
  const grid = document.querySelector('.kanban-grid');
  if (!grid || grid.dataset.dndEnabled !== '1') return;

  let dragged = null;

  document.querySelectorAll('.kanban-card').forEach((card) => {
    card.addEventListener('dragstart', (e) => {
      dragged = card;
      card.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    card.addEventListener('dragend', () => {
      card.classList.remove('dragging');
      dragged = null;
    });
  });

  document.querySelectorAll('.kanban-dropzone').forEach((zone) => {
    zone.addEventListener('dragover', (e) => {
      e.preventDefault();
      zone.classList.add('drop-hover');
    });
    zone.addEventListener('dragleave', () => zone.classList.remove('drop-hover'));
    zone.addEventListener('drop', async (e) => {
      e.preventDefault();
      zone.classList.remove('drop-hover');
      if (!dragged) return;

      const col = zone.closest('.kanban-col');
      const newStatus = col?.dataset.status;
      const taskId = dragged.dataset.taskId;
      if (!newStatus || !taskId) return;

      const oldCol = dragged.closest('.kanban-col');
      if (oldCol?.dataset.status === newStatus) return;

      zone.prepend(dragged);

      const body = new URLSearchParams();
      body.set('status', newStatus);
      const response = await fetch(`/tasks/${taskId}/status-json`, {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: body.toString(),
      });

      if (!response.ok) {
        if (oldCol) oldCol.querySelector('.kanban-dropzone')?.prepend(dragged);
        alert('Не удалось обновить статус задачи');
      }
    });
  });
})();
</script>
{% endblock %}
